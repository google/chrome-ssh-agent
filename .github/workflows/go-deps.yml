name: Go Dependencies
# File an issue when updates to Go dependencies are available. We can't use the
# standard 'go mod' support in Dependabot or Renovate since we also need to run
# gazelle to update Bazel's dependencies. See the following feature requests:
#   Renovate: https://github.com/renovatebot/renovate/issues/3347 (Gazelle)
#   Dependabot: https://github.com/dependabot/dependabot-core/issues/2196 (Bazel only)

on:
  schedule:
    # Run once per-week (Fridays). This creates an issue for a human to address,
    # so don't file new issues too much.
    - cron: '0 9 * * 6'
  workflow_dispatch:

jobs:
  go-deps:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v3
      - name: Setup Bazel
        run: bazel version || npm install -g @bazel/bazelisk
      - name: Update
        run: scripts/update-go-deps.sh
      - name: Detect Changes
        id: has-changes
        run: echo "changed=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT
      - uses: dacbd/create-issue-action@v1
        if: steps.has-changes.outputs.changed == 1
        with:
          title: Update Go Dependencies
          body: |
            Update to Go dependencies are available.

            To update, run

            ```
            scripts/update-go-deps.sh
            ```
